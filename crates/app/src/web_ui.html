<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CopyBot Real-Time Control Plane</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-a: #0b1118;
      --bg-b: #121d29;
      --panel: rgba(15, 23, 36, 0.84);
      --line: rgba(148, 163, 184, 0.18);
      --text: #e5edf5;
      --muted: #9ab0c7;
      --good: #34d399;
      --bad: #f87171;
      --warn: #fbbf24;
      --info: #38bdf8;
      --accent: #f59e0b;
    }
    body {
      font-family: Manrope, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.16), transparent 40%),
        radial-gradient(circle at 85% 15%, rgba(245, 158, 11, 0.12), transparent 38%),
        linear-gradient(145deg, var(--bg-a), var(--bg-b));
      min-height: 100vh;
    }
    .brand-font { font-family: "Space Grotesk", sans-serif; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      backdrop-filter: blur(14px);
      box-shadow: 0 16px 42px rgba(0, 0, 0, 0.28);
    }
    .panel-title {
      color: #c6d5e3;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: .72rem;
      font-weight: 700;
    }
    .kpi-value {
      font-size: 1.6rem;
      line-height: 1.1;
      font-weight: 800;
      letter-spacing: -.01em;
    }
    .status-pill {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: .2rem .7rem;
      font-size: .72rem;
      font-weight: 700;
      letter-spacing: .03em;
    }
    .dot {
      width: .5rem;
      height: .5rem;
      border-radius: 999px;
      display: inline-block;
      margin-right: .35rem;
    }
    .table-wrap {
      overflow: auto;
      border-radius: 1rem;
      border: 1px solid var(--line);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 860px;
    }
    th {
      position: sticky;
      top: 0;
      background: rgba(12, 20, 31, .95);
      z-index: 2;
      font-size: .74rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #9eb4ca;
      font-weight: 700;
      padding: .75rem .8rem;
      border-bottom: 1px solid var(--line);
      text-align: left;
    }
    td {
      padding: .66rem .8rem;
      border-bottom: 1px solid rgba(148, 163, 184, .12);
      font-size: .83rem;
      color: #d9e4ef;
      white-space: nowrap;
    }
    tr:hover td { background: rgba(56, 189, 248, .05); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .fade-in {
      animation: fadeIn .35s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(3px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="px-4 py-5 md:px-8">
  <div class="mx-auto max-w-[1700px] space-y-5">
    <header class="panel rounded-2xl p-4 md:p-5 fade-in">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="brand-font text-2xl font-bold md:text-3xl">CopyBot Real-Time Control Plane</h1>
          <p class="mt-1 text-sm text-slate-300">Live view of signals, positions, PnL, ingestion, risk, and discovery state.</p>
        </div>
        <div class="flex flex-col gap-2 md:items-end">
          <div class="flex flex-wrap items-center gap-2">
            <input id="tokenInput" type="password" placeholder="Bearer token" class="w-56 rounded-xl border border-slate-600/70 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 outline-none transition focus:border-amber-300 md:w-72" />
            <button id="saveTokenBtn" class="rounded-xl bg-amber-400 px-3 py-2 text-sm font-bold text-slate-950 transition hover:bg-amber-300">Save Token</button>
            <button id="refreshBtn" class="rounded-xl bg-sky-400 px-3 py-2 text-sm font-bold text-slate-950 transition hover:bg-sky-300">Refresh</button>
          </div>
          <div class="flex flex-wrap gap-2 text-xs">
            <span id="wsStatus" class="status-pill"><span class="dot bg-slate-400"></span>WS: disconnected</span>
            <span id="apiStatus" class="status-pill"><span class="dot bg-slate-400"></span>API: idle</span>
            <span id="lastUpdate" class="status-pill">Last update: never</span>
          </div>
        </div>
      </div>
    </header>

    <section class="grid grid-cols-2 gap-3 md:grid-cols-4 xl:grid-cols-8 fade-in" id="kpiGrid"></section>

    <section class="grid grid-cols-1 gap-4 xl:grid-cols-3">
      <article class="panel rounded-2xl p-4 fade-in">
        <h2 class="panel-title mb-2">Health Alerts</h2>
        <div id="alerts" class="space-y-2 text-sm text-slate-200"></div>
      </article>
      <article class="panel rounded-2xl p-4 fade-in">
        <h2 class="panel-title mb-2">Risk State</h2>
        <div id="riskSnapshot" class="space-y-1 text-sm text-slate-200"></div>
      </article>
      <article class="panel rounded-2xl p-4 fade-in">
        <h2 class="panel-title mb-2">Pipeline State</h2>
        <div id="pipelineSnapshot" class="space-y-1 text-sm text-slate-200"></div>
      </article>
    </section>

    <section class="grid grid-cols-1 gap-4 xl:grid-cols-2">
      <article class="panel rounded-2xl p-4 fade-in">
        <h2 class="panel-title mb-3">Open Lots</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Opened</th>
                <th>Wallet</th>
                <th>Token</th>
                <th>Qty</th>
                <th>Cost (SOL)</th>
                <th>Mark</th>
                <th>uPnL (SOL)</th>
                <th>uPnL %</th>
              </tr>
            </thead>
            <tbody id="lotsTable"></tbody>
          </table>
        </div>
      </article>
      <article class="panel rounded-2xl p-4 fade-in">
        <h2 class="panel-title mb-3">Closed Trades</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Closed</th>
                <th>Wallet</th>
                <th>Token</th>
                <th>Qty</th>
                <th>Entry</th>
                <th>Exit</th>
                <th>PnL</th>
                <th>Hold</th>
              </tr>
            </thead>
            <tbody id="tradesTable"></tbody>
          </table>
        </div>
      </article>
    </section>

    <section class="grid grid-cols-1 gap-4 xl:grid-cols-2">
      <article class="panel rounded-2xl p-4 fade-in">
        <h2 class="panel-title mb-3">Signals Timeline</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Kind</th>
                <th>Wallet</th>
                <th>Token</th>
                <th>Side</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Signature</th>
              </tr>
            </thead>
            <tbody id="signalsTable"></tbody>
          </table>
        </div>
      </article>
      <article class="panel rounded-2xl p-4 fade-in">
        <h2 class="panel-title mb-3">Discovery Top Wallets</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Wallet</th>
                <th>Score</th>
                <th>Trades</th>
                <th>PnL</th>
                <th>Win Rate</th>
                <th>Tradable</th>
                <th>Rug</th>
              </tr>
            </thead>
            <tbody id="discoveryTable"></tbody>
          </table>
        </div>
      </article>
    </section>

    <section class="panel rounded-2xl p-4 fade-in">
      <div class="mb-3 flex items-center justify-between">
        <h2 class="panel-title">Live Event Feed</h2>
        <span id="eventCount" class="text-xs text-slate-300">0 events</span>
      </div>
      <div id="eventFeed" class="max-h-72 space-y-1 overflow-auto rounded-xl border border-slate-700/70 bg-slate-950/60 p-3 text-xs"></div>
    </section>
  </div>

  <script>
    const fmtNum = (v, d = 4) => (v === null || v === undefined || Number.isNaN(Number(v))) ? "—" : Number(v).toFixed(d);
    const fmtPct = (v) => (v === null || v === undefined || Number.isNaN(Number(v))) ? "—" : `${(Number(v) * 100).toFixed(2)}%`;
    const fmtTs = (v) => v ? new Date(v).toLocaleString() : "—";
    const short = (s, n = 8) => s ? `${s.slice(0, n)}…${s.slice(-4)}` : "—";
    const toColor = (v) => (Number(v) >= 0 ? "text-emerald-300" : "text-rose-300");
    const eventFeedLimit = 200;

    const state = {
      token: localStorage.getItem("copybot_token") || "",
      ws: null,
      events: [],
      refreshTimer: null,
      wsRetryTimer: null,
    };

    const els = {
      tokenInput: document.getElementById("tokenInput"),
      saveTokenBtn: document.getElementById("saveTokenBtn"),
      refreshBtn: document.getElementById("refreshBtn"),
      wsStatus: document.getElementById("wsStatus"),
      apiStatus: document.getElementById("apiStatus"),
      lastUpdate: document.getElementById("lastUpdate"),
      kpiGrid: document.getElementById("kpiGrid"),
      alerts: document.getElementById("alerts"),
      riskSnapshot: document.getElementById("riskSnapshot"),
      pipelineSnapshot: document.getElementById("pipelineSnapshot"),
      lotsTable: document.getElementById("lotsTable"),
      tradesTable: document.getElementById("tradesTable"),
      signalsTable: document.getElementById("signalsTable"),
      discoveryTable: document.getElementById("discoveryTable"),
      eventFeed: document.getElementById("eventFeed"),
      eventCount: document.getElementById("eventCount"),
    };

    els.tokenInput.value = state.token;

    function setWsStatus(label, color) {
      els.wsStatus.innerHTML = `<span class="dot ${color}"></span>WS: ${label}`;
    }

    function setApiStatus(label, color) {
      els.apiStatus.innerHTML = `<span class="dot ${color}"></span>API: ${label}`;
    }

    function authHeaders() {
      return {
        "Authorization": `Bearer ${state.token}`
      };
    }

    async function apiGet(path) {
      if (!state.token) throw new Error("token is empty");
      const res = await fetch(path, {
        headers: authHeaders(),
      });
      if (!res.ok) {
        const payload = await res.json().catch(() => ({}));
        const msg = payload.error || `${res.status} ${res.statusText}`;
        throw new Error(msg);
      }
      return res.json();
    }

    function solscanTx(sig) {
      return sig ? `https://solscan.io/tx/${sig}` : "#";
    }

    function solscanToken(token) {
      return token ? `https://solscan.io/token/${token}` : "#";
    }

    function solscanWallet(wallet) {
      return wallet ? `https://solscan.io/account/${wallet}` : "#";
    }

    function renderKpis(dashboard) {
      const k = dashboard.kpis;
      const alerts = dashboard.health_alerts?.length || 0;
      const cards = [
        ["PnL 1h", fmtNum(k.realized_pnl_1h), Number(k.realized_pnl_1h) >= 0 ? "text-emerald-300" : "text-rose-300"],
        ["PnL 6h", fmtNum(k.realized_pnl_6h), Number(k.realized_pnl_6h) >= 0 ? "text-emerald-300" : "text-rose-300"],
        ["PnL 24h", fmtNum(k.realized_pnl_24h), Number(k.realized_pnl_24h) >= 0 ? "text-emerald-300" : "text-rose-300"],
        ["Win Rate 24h", fmtPct(k.win_rate_24h), "text-sky-300"],
        ["Open Lots", k.open_lots, "text-amber-300"],
        ["Open Notional", fmtNum(k.open_notional_sol), "text-amber-300"],
        ["Signals 24h", k.copy_signals_24h, "text-sky-300"],
        ["Alerts", alerts, alerts > 0 ? "text-rose-300" : "text-emerald-300"],
      ];
      els.kpiGrid.innerHTML = cards.map(([name, value, color]) => `
        <div class="panel rounded-xl p-3">
          <div class="panel-title">${name}</div>
          <div class="kpi-value mt-2 ${color}">${value}</div>
        </div>
      `).join("");
    }

    function renderAlerts(alerts) {
      if (!alerts || !alerts.length) {
        els.alerts.innerHTML = `<div class="rounded-lg border border-emerald-400/30 bg-emerald-400/10 px-3 py-2 text-emerald-200">No active alerts.</div>`;
        return;
      }
      els.alerts.innerHTML = alerts.map((a) => {
        const cls = a.severity === "error" ? "border-rose-400/40 bg-rose-400/10 text-rose-200" : "border-amber-400/40 bg-amber-400/10 text-amber-100";
        return `<div class="rounded-lg border px-3 py-2 ${cls}">
          <div class="font-semibold">${a.code}</div>
          <div class="text-xs opacity-90">${a.message}</div>
        </div>`;
      }).join("");
    }

    function renderRisk(risk) {
      const rows = [
        ["Killswitch", risk.killswitch_enabled ? "enabled" : "disabled"],
        ["Hard stop", risk.hard_stop_reason || "none"],
        ["Pause", risk.pause_reason || "none"],
        ["Universe blocked", String(risk.universe_blocked)],
        ["Infra blocked", risk.infra_block_reason || "none"],
        ["Exposure blocked", String(risk.exposure_hard_blocked)],
        ["Updated", fmtTs(risk.updated_at)],
      ];
      els.riskSnapshot.innerHTML = rows.map(([k, v]) => `<div><span class="text-slate-400">${k}:</span> <span class="mono">${v}</span></div>`).join("");
    }

    function renderPipeline(ingestion, scheduler) {
      const rows = [
        ["Last swap", fmtTs(ingestion.last_swap_ts)],
        ["Lag p95 (ms)", ingestion.ingestion_lag_ms_p95],
        ["WS enqueued", ingestion.ws_notifications_enqueued],
        ["WS replaced oldest", ingestion.ws_notifications_replaced_oldest],
        ["RPC 429", ingestion.rpc_429],
        ["RPC 5xx", ingestion.rpc_5xx],
        ["Queue pending", `${scheduler.pending_tasks}/${scheduler.pending_capacity}`],
        ["Backpressure", String(scheduler.queue_backpressure_active)],
        ["Inflight keys", scheduler.inflight_keys],
        ["Workers", scheduler.worker_count],
      ];
      els.pipelineSnapshot.innerHTML = rows.map(([k, v]) => `<div><span class="text-slate-400">${k}:</span> <span class="mono">${v}</span></div>`).join("");
    }

    function renderLots(lots) {
      els.lotsTable.innerHTML = (lots || []).map((lot) => {
        const pnlClass = toColor(lot.unrealized_pnl_sol || 0);
        const wallet = short(lot.wallet_id, 6);
        const token = short(lot.token, 6);
        return `
          <tr>
            <td>${fmtTs(lot.opened_ts)}</td>
            <td><a class="text-sky-300 hover:underline mono" href="${solscanWallet(lot.wallet_id)}" target="_blank">${wallet}</a></td>
            <td><a class="text-sky-300 hover:underline mono" href="${solscanToken(lot.token)}" target="_blank">${token}</a></td>
            <td class="mono">${fmtNum(lot.qty, 6)}</td>
            <td class="mono">${fmtNum(lot.cost_sol, 5)}</td>
            <td class="mono">${lot.mark_price_sol_per_token === null ? "<span class='text-amber-300'>N/A</span>" : fmtNum(lot.mark_price_sol_per_token, 8)}</td>
            <td class="mono ${pnlClass}">${lot.unrealized_pnl_sol === null ? "N/A" : fmtNum(lot.unrealized_pnl_sol, 5)}</td>
            <td class="mono ${pnlClass}">${lot.unrealized_return_pct === null ? "N/A" : fmtPct(lot.unrealized_return_pct)}</td>
          </tr>
        `;
      }).join("");
    }

    function renderTrades(trades) {
      els.tradesTable.innerHTML = (trades || []).map((t) => {
        const pnlClass = toColor(t.pnl_sol);
        return `
          <tr>
            <td>${fmtTs(t.closed_ts)}</td>
            <td><a class="text-sky-300 hover:underline mono" href="${solscanWallet(t.wallet_id)}" target="_blank">${short(t.wallet_id, 6)}</a></td>
            <td><a class="text-sky-300 hover:underline mono" href="${solscanToken(t.token)}" target="_blank">${short(t.token, 6)}</a></td>
            <td class="mono">${fmtNum(t.qty, 6)}</td>
            <td class="mono">${fmtNum(t.entry_price_sol_per_token, 8)}</td>
            <td class="mono">${fmtNum(t.exit_price_sol_per_token, 8)}</td>
            <td class="mono ${pnlClass}">${fmtNum(t.pnl_sol, 5)} (${fmtPct(t.return_pct)})</td>
            <td class="mono">${t.hold_seconds}s</td>
          </tr>
        `;
      }).join("");
    }

    function renderSignals(items) {
      els.signalsTable.innerHTML = (items || []).map((s) => {
        const kindCls = s.kind === "dropped" ? "text-rose-300" : "text-emerald-300";
        const reason = s.reason || "—";
        const sig = s.signature ? `<a class="text-sky-300 hover:underline mono" href="${solscanTx(s.signature)}" target="_blank">${short(s.signature, 8)}</a>` : "—";
        return `
          <tr>
            <td>${fmtTs(s.ts)}</td>
            <td class="${kindCls} font-semibold">${s.kind}</td>
            <td>${s.wallet_id ? `<a class="text-sky-300 hover:underline mono" href="${solscanWallet(s.wallet_id)}" target="_blank">${short(s.wallet_id, 6)}</a>` : "—"}</td>
            <td>${s.token ? `<a class="text-sky-300 hover:underline mono" href="${solscanToken(s.token)}" target="_blank">${short(s.token, 6)}</a>` : "—"}</td>
            <td class="mono">${s.side || "—"}</td>
            <td class="mono">${reason}</td>
            <td class="mono">${s.status || "—"}</td>
            <td>${sig}</td>
          </tr>
        `;
      }).join("");
    }

    function renderDiscovery(metrics) {
      els.discoveryTable.innerHTML = (metrics || []).map((m) => `
        <tr>
          <td><a class="text-sky-300 hover:underline mono" href="${solscanWallet(m.wallet_id)}" target="_blank">${short(m.wallet_id, 6)}</a></td>
          <td class="mono">${fmtNum(m.score, 4)}</td>
          <td class="mono">${m.trades}</td>
          <td class="mono ${toColor(m.pnl)}">${fmtNum(m.pnl, 4)}</td>
          <td class="mono">${fmtPct(m.win_rate)}</td>
          <td class="mono">${fmtPct(m.tradable_ratio)}</td>
          <td class="mono">${fmtPct(m.rug_ratio)}</td>
        </tr>
      `).join("");
    }

    function pushEvent(event) {
      state.events.unshift(event);
      if (state.events.length > eventFeedLimit) state.events.length = eventFeedLimit;
      els.eventCount.textContent = `${state.events.length} events`;
      els.eventFeed.innerHTML = state.events.map((e) => {
        const color =
          e.type === "signal_recorded" ? "text-emerald-300" :
          e.type === "signal_dropped" ? "text-rose-300" :
          e.type === "risk_state_changed" ? "text-amber-300" :
          e.type === "lagged" ? "text-rose-300" :
          "text-sky-300";
        const payload = typeof e.payload === "object" ? JSON.stringify(e.payload) : String(e.payload ?? "");
        return `<div class="mono border-b border-slate-700/60 pb-1 ${color}">
          [${fmtTs(e.ts)}] ${e.type}: <span class="text-slate-300">${payload}</span>
        </div>`;
      }).join("");
    }

    function connectWs() {
      if (!state.token) return;
      if (state.ws) {
        state.ws.close();
        state.ws = null;
      }
      const scheme = location.protocol === "https:" ? "wss" : "ws";
      const url = `${scheme}://${location.host}/ws/live?token=${encodeURIComponent(state.token)}`;
      const ws = new WebSocket(url);
      state.ws = ws;

      ws.onopen = () => {
        setWsStatus("connected", "bg-emerald-400");
      };
      ws.onclose = () => {
        setWsStatus("disconnected", "bg-rose-400");
        if (state.wsRetryTimer) clearTimeout(state.wsRetryTimer);
        state.wsRetryTimer = setTimeout(connectWs, 3000);
      };
      ws.onerror = () => {
        setWsStatus("error", "bg-rose-400");
      };
      ws.onmessage = (msg) => {
        let payload;
        try {
          payload = JSON.parse(msg.data);
        } catch {
          return;
        }
        pushEvent(payload);
        if (payload.type === "lagged") {
          refreshAll();
          return;
        }
        if (["signal_recorded", "signal_dropped", "lot_opened", "lot_closed", "risk_state_changed", "ingestion_snapshot", "discovery_cycle_done", "health_alert"].includes(payload.type)) {
          refreshAll();
        }
      };
    }

    async function refreshAll() {
      try {
        setApiStatus("loading", "bg-amber-400");
        const [dashboard, lots, trades, signals, risk, ingestion, discovery] = await Promise.all([
          apiGet("/api/dashboard"),
          apiGet("/api/lots?limit=200"),
          apiGet("/api/trades?limit=200"),
          apiGet("/api/signals?limit=250"),
          apiGet("/api/risk"),
          apiGet("/api/ingestion"),
          apiGet("/api/discovery"),
        ]);
        renderKpis(dashboard);
        renderAlerts(dashboard.health_alerts || []);
        renderRisk(risk.runtime || {});
        renderPipeline(ingestion.runtime || {}, ingestion.scheduler || {});
        renderLots(lots.lots || []);
        renderTrades(trades.trades || []);
        renderSignals(signals.items || []);
        renderDiscovery(discovery.top_metrics || []);
        setApiStatus("ok", "bg-emerald-400");
        els.lastUpdate.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        setApiStatus(String(err.message || err), "bg-rose-400");
      }
    }

    function saveToken() {
      state.token = els.tokenInput.value.trim();
      localStorage.setItem("copybot_token", state.token);
      state.events = [];
      pushEvent({ type: "local", ts: new Date().toISOString(), payload: { message: "token updated" }});
      connectWs();
      refreshAll();
    }

    els.saveTokenBtn.addEventListener("click", saveToken);
    els.refreshBtn.addEventListener("click", refreshAll);
    els.tokenInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") saveToken();
    });

    function bootstrap() {
      if (!state.token) {
        setApiStatus("set token first", "bg-amber-400");
        setWsStatus("token missing", "bg-amber-400");
        return;
      }
      connectWs();
      refreshAll();
      if (state.refreshTimer) clearInterval(state.refreshTimer);
      state.refreshTimer = setInterval(refreshAll, 15000);
    }

    bootstrap();
  </script>
</body>
</html>
