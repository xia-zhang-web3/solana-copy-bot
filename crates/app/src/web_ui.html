<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CopyBot Real-Time Control Plane</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #eef2f7;
      --panel: #ffffff;
      --panel-dark: #111a2c;
      --line: #d6dfeb;
      --text: #0f172a;
      --muted: #607089;
      --good: #059669;
      --bad: #dc2626;
      --warn: #b45309;
      --accent: #1d4ed8;
    }
    body {
      font-family: Manrope, sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .brand-font {
      font-family: "Space Grotesk", sans-serif;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    .panel-dark {
      background: var(--panel-dark);
      border: 1px solid #26364f;
      border-radius: 1rem;
      box-shadow: 0 14px 34px rgba(2, 6, 23, 0.32);
      color: #d8e5ff;
    }
    .panel-title {
      color: #5c6b7f;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: .72rem;
      font-weight: 800;
    }
    .kpi-value {
      font-size: 1.55rem;
      line-height: 1.1;
      font-weight: 800;
      letter-spacing: -.01em;
    }
    .status-pill {
      border: 1px solid #324764;
      background: rgba(15, 23, 42, 0.35);
      border-radius: 999px;
      padding: .23rem .75rem;
      font-size: .73rem;
      font-weight: 700;
      letter-spacing: .02em;
      color: #d6e3fd;
      display: inline-flex;
      align-items: center;
    }
    .dot {
      width: .5rem;
      height: .5rem;
      border-radius: 999px;
      display: inline-block;
      margin-right: .35rem;
    }
    .table-wrap {
      overflow: auto;
      border-radius: .95rem;
      border: 1px solid var(--line);
      max-height: min(62vh, 680px);
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    th {
      position: sticky;
      top: 0;
      background: #0f172a;
      color: #d4deec;
      z-index: 2;
      font-size: .73rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 700;
      padding: .72rem .78rem;
      border-bottom: 1px solid #23314a;
      text-align: left;
    }
    td {
      padding: .64rem .78rem;
      border-bottom: 1px solid #e4eaf3;
      font-size: .83rem;
      color: #142135;
      white-space: nowrap;
    }
    tr:hover td {
      background: #f4f8ff;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .nav-btn {
      width: 100%;
      border: 1px solid #2a3e5d;
      background: #17233a;
      color: #d7e4fc;
      border-radius: .75rem;
      text-align: left;
      padding: .58rem .72rem;
      font-size: .86rem;
      font-weight: 700;
      transition: .15s ease;
    }
    .nav-btn:hover {
      background: #20314d;
      border-color: #36507a;
    }
    .nav-btn.active {
      background: #e8f0ff;
      color: #0d1b33;
      border-color: #8eb3ff;
    }
    .view-pane {
      display: none;
    }
    .view-pane.active {
      display: block;
    }
    .pager-btn {
      border: 1px solid #c7d2e5;
      background: #fff;
      border-radius: .6rem;
      padding: .35rem .7rem;
      font-size: .75rem;
      font-weight: 700;
      color: #20314d;
    }
    .pager-btn:disabled {
      opacity: .45;
      cursor: not-allowed;
    }
    .event-line {
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
  </style>
</head>
<body class="p-3 md:p-5">
  <div class="mx-auto flex max-w-[1900px] flex-col gap-4 lg:flex-row">
    <aside class="panel-dark w-full p-4 lg:sticky lg:top-4 lg:h-[calc(100vh-2rem)] lg:w-64 lg:shrink-0 lg:overflow-auto">
      <div>
        <h1 class="brand-font text-xl font-bold">CopyBot Console</h1>
        <p class="mt-1 text-xs text-slate-300">Real-time control plane</p>
      </div>

      <nav id="viewNav" class="mt-4 space-y-2">
        <button class="nav-btn" data-view="overview">Overview</button>
        <button class="nav-btn" data-view="positions">Positions</button>
        <button class="nav-btn" data-view="signals">Signals</button>
        <button class="nav-btn" data-view="discovery">Discovery</button>
        <button class="nav-btn" data-view="events">Live Feed</button>
      </nav>

      <div class="mt-4 border-t border-slate-700/60 pt-3">
        <div class="space-y-2 text-xs">
          <span id="wsStatus" class="status-pill"><span class="dot bg-slate-400"></span>WS: disconnected</span>
          <span id="apiStatus" class="status-pill"><span class="dot bg-slate-400"></span>API: idle</span>
          <span id="lastUpdate" class="status-pill">Last update: never</span>
        </div>
      </div>
    </aside>

    <main class="flex-1 space-y-4">
      <header class="panel p-4 md:p-5">
        <div class="flex flex-col gap-4 xl:flex-row xl:items-center xl:justify-between">
          <div>
            <h2 class="brand-font text-2xl font-bold text-slate-900 md:text-3xl">CopyBot Real-Time Control Plane</h2>
            <p class="mt-1 text-sm text-slate-600">Signals, positions, PnL, ingestion, risk and discovery in one place.</p>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <input id="tokenInput" type="password" placeholder="Bearer token" class="w-56 rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 outline-none transition focus:border-blue-400 md:w-80" />
            <button id="saveTokenBtn" class="rounded-xl bg-amber-400 px-3 py-2 text-sm font-bold text-slate-950 transition hover:bg-amber-300">Save Token</button>
            <button id="refreshBtn" class="rounded-xl bg-blue-600 px-3 py-2 text-sm font-bold text-white transition hover:bg-blue-500">Refresh</button>
            <button id="pauseFeedBtn" class="rounded-xl bg-slate-700 px-3 py-2 text-sm font-bold text-white transition hover:bg-slate-600">Pause Feed</button>
            <button id="toggleAutoBtn" class="rounded-xl bg-emerald-600 px-3 py-2 text-sm font-bold text-white transition hover:bg-emerald-500">Auto: ON</button>
          </div>
        </div>
      </header>

      <section id="view-overview" class="view-pane active space-y-4">
        <section class="grid grid-cols-2 gap-3 md:grid-cols-4 xl:grid-cols-8" id="kpiGrid"></section>

        <section class="grid grid-cols-1 gap-4 xl:grid-cols-3">
          <article class="panel p-4">
            <h3 class="panel-title mb-2">Health Alerts</h3>
            <div id="alerts" class="space-y-2 text-sm text-slate-900"></div>
          </article>
          <article class="panel p-4">
            <h3 class="panel-title mb-2">Risk State</h3>
            <div id="riskSnapshot" class="space-y-1 text-sm text-slate-900"></div>
          </article>
          <article class="panel p-4">
            <h3 class="panel-title mb-2">Pipeline State</h3>
            <div id="pipelineSnapshot" class="space-y-1 text-sm text-slate-900"></div>
          </article>
        </section>
      </section>

      <section id="view-positions" class="view-pane space-y-4">
        <article class="panel p-4">
          <div class="mb-3 flex items-center justify-between gap-3">
            <h3 class="panel-title">Open Lots</h3>
            <div class="flex items-center gap-2 text-xs">
              <button id="lotsPrevBtn" class="pager-btn">Prev</button>
              <span id="lotsPageInfo" class="mono text-slate-600">0</span>
              <button id="lotsNextBtn" class="pager-btn">Next</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Opened</th>
                  <th>Wallet</th>
                  <th>Token</th>
                  <th>Qty</th>
                  <th>Cost (SOL)</th>
                  <th>Mark</th>
                  <th>uPnL (SOL)</th>
                  <th>uPnL %</th>
                </tr>
              </thead>
              <tbody id="lotsTable"></tbody>
            </table>
          </div>
        </article>

        <article class="panel p-4">
          <div class="mb-3 flex items-center justify-between gap-3">
            <h3 class="panel-title">Closed Trades</h3>
            <div class="flex items-center gap-2 text-xs">
              <button id="tradesPrevBtn" class="pager-btn">Prev</button>
              <span id="tradesPageInfo" class="mono text-slate-600">0</span>
              <button id="tradesNextBtn" class="pager-btn">Next</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Closed</th>
                  <th>Wallet</th>
                  <th>Token</th>
                  <th>Qty</th>
                  <th>Entry</th>
                  <th>Exit</th>
                  <th>PnL</th>
                  <th>Hold</th>
                </tr>
              </thead>
              <tbody id="tradesTable"></tbody>
            </table>
          </div>
        </article>
      </section>

      <section id="view-signals" class="view-pane space-y-4">
        <article class="panel p-4">
          <div class="mb-3 flex items-center justify-between gap-3">
            <h3 class="panel-title">Signals Timeline</h3>
            <div class="flex items-center gap-2 text-xs">
              <button id="signalsPrevBtn" class="pager-btn">Prev</button>
              <span id="signalsPageInfo" class="mono text-slate-600">0</span>
              <button id="signalsNextBtn" class="pager-btn">Next</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Kind</th>
                  <th>Wallet</th>
                  <th>Token</th>
                  <th>Side</th>
                  <th>Reason</th>
                  <th>Status</th>
                  <th>Signature</th>
                </tr>
              </thead>
              <tbody id="signalsTable"></tbody>
            </table>
          </div>
        </article>
      </section>

      <section id="view-discovery" class="view-pane space-y-4">
        <article class="panel p-4">
          <div id="discoveryRuntime" class="mb-3 rounded-lg border border-slate-200 bg-slate-50 p-2 text-xs text-slate-600"></div>
          <div class="mb-3 flex items-center justify-between gap-3">
            <h3 class="panel-title">Discovery Top Wallets</h3>
            <div class="flex items-center gap-2 text-xs">
              <button id="discoveryPrevBtn" class="pager-btn">Prev</button>
              <span id="discoveryPageInfo" class="mono text-slate-600">0</span>
              <button id="discoveryNextBtn" class="pager-btn">Next</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Score</th>
                  <th>Trades</th>
                  <th>PnL</th>
                  <th>Win Rate</th>
                  <th>Tradable</th>
                  <th>Rug</th>
                </tr>
              </thead>
              <tbody id="discoveryTable"></tbody>
            </table>
          </div>
        </article>
      </section>

      <section id="view-events" class="view-pane space-y-4">
        <article class="panel p-4">
          <div class="mb-3 flex items-center justify-between">
            <h3 class="panel-title">Live Event Feed</h3>
            <span id="eventCount" class="text-xs text-slate-600">0 events</span>
          </div>
          <div id="eventFeed" class="mono max-h-[72vh] space-y-1 overflow-auto overflow-x-hidden rounded-xl border border-slate-300 bg-[#0f172a] p-3 text-xs text-slate-100"></div>
        </article>
      </section>
    </main>
  </div>

  <script>
    const fmtNum = (v, d = 4) => (v === null || v === undefined || Number.isNaN(Number(v))) ? "—" : Number(v).toFixed(d);
    const fmtPct = (v) => (v === null || v === undefined || Number.isNaN(Number(v))) ? "—" : `${(Number(v) * 100).toFixed(2)}%`;
    const fmtTs = (v) => v ? new Date(v).toLocaleString() : "—";
    const short = (s, n = 8) => s ? `${s.slice(0, n)}…${s.slice(-4)}` : "—";
    const toColor = (v) => (Number(v) >= 0 ? "text-emerald-600" : "text-rose-600");
    const eventFeedLimit = 200;
    const refreshCooldownMs = 6000;
    const requestTimeoutMs = 10000;
    const discoveryRequestTimeoutMs = 35000;
    const eventFeedRenderMs = 350;
    const wsViewTriggers = {
      overview: new Set(["lot_opened", "lot_closed", "signal_recorded", "risk_state_changed", "health_alert"]),
      positions: new Set(["lot_opened", "lot_closed"]),
      signals: new Set(["signal_recorded", "signal_dropped"]),
      discovery: new Set(["discovery_cycle_done"]),
      events: new Set([]),
    };
    const validViews = new Set(Object.keys(wsViewTriggers));

    const PAGE_LIMITS = {
      lots: 40,
      trades: 40,
      signals: 50,
      discovery: 40,
    };

    function normalizeToken(value) {
      const raw = String(value || "").trim();
      if (!raw) return "";
      if (raw.toLowerCase().startsWith("bearer ")) {
        return raw.slice(7).trim();
      }
      return raw;
    }

    const state = {
      token: normalizeToken(localStorage.getItem("copybot_token")),
      activeView: localStorage.getItem("copybot_view") || "overview",
      ws: null,
      events: [],
      refreshTimer: null,
      wsRetryTimer: null,
      refreshDebounceTimer: null,
      refreshInFlight: false,
      refreshQueued: false,
      lastRefreshStartedAt: 0,
      autoRefreshEnabled: true,
      feedPaused: false,
      feedRenderTimer: null,
      pagination: {
        lots: { page: 0, limit: PAGE_LIMITS.lots, hasMore: false, count: 0 },
        trades: { page: 0, limit: PAGE_LIMITS.trades, hasMore: false, count: 0 },
        signals: { page: 0, limit: PAGE_LIMITS.signals, hasMore: false, count: 0 },
        discovery: { page: 0, limit: PAGE_LIMITS.discovery, hasMore: false, count: 0 },
      }
    };

    const els = {
      tokenInput: document.getElementById("tokenInput"),
      saveTokenBtn: document.getElementById("saveTokenBtn"),
      refreshBtn: document.getElementById("refreshBtn"),
      pauseFeedBtn: document.getElementById("pauseFeedBtn"),
      toggleAutoBtn: document.getElementById("toggleAutoBtn"),
      wsStatus: document.getElementById("wsStatus"),
      apiStatus: document.getElementById("apiStatus"),
      lastUpdate: document.getElementById("lastUpdate"),
      kpiGrid: document.getElementById("kpiGrid"),
      alerts: document.getElementById("alerts"),
      riskSnapshot: document.getElementById("riskSnapshot"),
      pipelineSnapshot: document.getElementById("pipelineSnapshot"),
      discoveryRuntime: document.getElementById("discoveryRuntime"),
      lotsTable: document.getElementById("lotsTable"),
      tradesTable: document.getElementById("tradesTable"),
      signalsTable: document.getElementById("signalsTable"),
      discoveryTable: document.getElementById("discoveryTable"),
      eventFeed: document.getElementById("eventFeed"),
      eventCount: document.getElementById("eventCount"),
      viewButtons: Array.from(document.querySelectorAll("#viewNav [data-view]")),
      panes: Array.from(document.querySelectorAll(".view-pane")),
      pagers: {
        lots: {
          prev: document.getElementById("lotsPrevBtn"),
          next: document.getElementById("lotsNextBtn"),
          info: document.getElementById("lotsPageInfo"),
        },
        trades: {
          prev: document.getElementById("tradesPrevBtn"),
          next: document.getElementById("tradesNextBtn"),
          info: document.getElementById("tradesPageInfo"),
        },
        signals: {
          prev: document.getElementById("signalsPrevBtn"),
          next: document.getElementById("signalsNextBtn"),
          info: document.getElementById("signalsPageInfo"),
        },
        discovery: {
          prev: document.getElementById("discoveryPrevBtn"),
          next: document.getElementById("discoveryNextBtn"),
          info: document.getElementById("discoveryPageInfo"),
        }
      }
    };

    function setWsStatus(label, color) {
      els.wsStatus.innerHTML = `<span class="dot ${color}"></span>WS: ${label}`;
    }

    function setApiStatus(label, color) {
      els.apiStatus.innerHTML = `<span class="dot ${color}"></span>API: ${label}`;
    }

    function updatePauseFeedButton() {
      els.pauseFeedBtn.textContent = state.feedPaused ? "Resume Feed" : "Pause Feed";
      els.pauseFeedBtn.className = state.feedPaused
        ? "rounded-xl bg-rose-600 px-3 py-2 text-sm font-bold text-white transition hover:bg-rose-500"
        : "rounded-xl bg-slate-700 px-3 py-2 text-sm font-bold text-white transition hover:bg-slate-600";
    }

    function updateAutoRefreshButton() {
      els.toggleAutoBtn.textContent = state.autoRefreshEnabled ? "Auto: ON" : "Auto: OFF";
      els.toggleAutoBtn.className = state.autoRefreshEnabled
        ? "rounded-xl bg-emerald-600 px-3 py-2 text-sm font-bold text-white transition hover:bg-emerald-500"
        : "rounded-xl bg-slate-600 px-3 py-2 text-sm font-bold text-white transition hover:bg-slate-500";
    }

    function updateEventCount() {
      const suffix = state.feedPaused ? " (paused)" : "";
      els.eventCount.textContent = `${state.events.length} events${suffix}`;
    }

    function updateNavButtons() {
      els.viewButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.view === state.activeView);
      });
    }

    function setActiveView(view, triggerRefresh = true) {
      state.activeView = view;
      localStorage.setItem("copybot_view", view);
      els.panes.forEach((pane) => {
        pane.classList.toggle("active", pane.id === `view-${view}`);
      });
      updateNavButtons();
      if (triggerRefresh) {
        queueRefresh(true);
      }
    }

    function authHeaders() {
      return {
        "Authorization": `Bearer ${state.token}`
      };
    }

    function apiPathWithToken(path) {
      const url = new URL(path, location.origin);
      if (state.token) {
        url.searchParams.set("token", state.token);
      }
      return `${url.pathname}${url.search}`;
    }

    function timeoutForPath(path) {
      if (String(path || "").startsWith("/api/discovery")) {
        return discoveryRequestTimeoutMs;
      }
      return requestTimeoutMs;
    }

    async function apiGet(path) {
      if (!state.token) throw new Error("token is empty");
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), timeoutForPath(path));
      let res;
      try {
        res = await fetch(apiPathWithToken(path), {
          headers: authHeaders(),
          signal: controller.signal,
          cache: "no-store",
        });
      } catch (error) {
        if (error && error.name === "AbortError") {
          throw new Error(`timeout: ${path}`);
        }
        throw new Error(`network error: ${path}`);
      } finally {
        clearTimeout(timeout);
      }
      if (!res.ok) {
        const payload = await res.json().catch(() => ({}));
        const msg = payload.error || `${res.status} ${res.statusText}`;
        throw new Error(msg);
      }
      return res.json();
    }

    async function fetchNamed(name, path) {
      try {
        return { name, ok: true, data: await apiGet(path) };
      } catch (error) {
        return { name, ok: false, error };
      }
    }

    function tableEmptyRow(colspan, text = "No data") {
      return `<tr><td colspan="${colspan}" class="text-center text-slate-500">${text}</td></tr>`;
    }

    function renderKpis(dashboard) {
      const k = dashboard.kpis;
      const alerts = dashboard.health_alerts?.length || 0;
      const cards = [
        ["PnL 1h", fmtNum(k.realized_pnl_1h), Number(k.realized_pnl_1h) >= 0 ? "text-emerald-600" : "text-rose-600"],
        ["PnL 6h", fmtNum(k.realized_pnl_6h), Number(k.realized_pnl_6h) >= 0 ? "text-emerald-600" : "text-rose-600"],
        ["PnL 24h", fmtNum(k.realized_pnl_24h), Number(k.realized_pnl_24h) >= 0 ? "text-emerald-600" : "text-rose-600"],
        ["Win Rate 24h", fmtPct(k.win_rate_24h), "text-blue-700"],
        ["Open Lots", k.open_lots, "text-amber-700"],
        ["Open Notional", fmtNum(k.open_notional_sol), "text-amber-700"],
        ["Signals 24h", k.copy_signals_24h, "text-blue-700"],
        ["Alerts", alerts, alerts > 0 ? "text-rose-700" : "text-emerald-700"],
      ];
      els.kpiGrid.innerHTML = cards.map(([name, value, color]) => `
        <div class="panel p-3">
          <div class="panel-title">${name}</div>
          <div class="kpi-value mt-2 ${color}">${value}</div>
        </div>
      `).join("");
    }

    function renderAlerts(alerts) {
      if (!alerts || !alerts.length) {
        els.alerts.innerHTML = `<div class="rounded-lg border border-emerald-300 bg-emerald-50 px-3 py-2 text-emerald-800">No active alerts.</div>`;
        return;
      }
      els.alerts.innerHTML = alerts.map((a) => {
        const cls = a.severity === "error" ? "border-rose-300 bg-rose-50 text-rose-800" : "border-amber-300 bg-amber-50 text-amber-900";
        return `<div class="rounded-lg border px-3 py-2 ${cls}">
          <div class="font-semibold">${a.code}</div>
          <div class="text-xs opacity-90">${a.message}</div>
        </div>`;
      }).join("");
    }

    function renderRisk(risk) {
      const rows = [
        ["Killswitch", risk.killswitch_enabled ? "enabled" : "disabled"],
        ["Hard stop", risk.hard_stop_reason || "none"],
        ["Pause", risk.pause_reason || "none"],
        ["Universe blocked", String(risk.universe_blocked)],
        ["Infra blocked", risk.infra_block_reason || "none"],
        ["Exposure blocked", String(risk.exposure_hard_blocked)],
        ["Updated", fmtTs(risk.updated_at)],
      ];
      els.riskSnapshot.innerHTML = rows.map(([k, v]) => `<div><span class="text-slate-500">${k}:</span> <span class="mono">${v}</span></div>`).join("");
    }

    function renderPipeline(ingestion, scheduler) {
      const rows = [
        ["Last swap", fmtTs(ingestion.last_swap_ts)],
        ["Lag p95 (ms)", ingestion.ingestion_lag_ms_p95],
        ["WS enqueued", ingestion.ws_notifications_enqueued],
        ["WS replaced oldest", ingestion.ws_notifications_replaced_oldest],
        ["RPC 429", ingestion.rpc_429],
        ["RPC 5xx", ingestion.rpc_5xx],
        ["Queue pending", `${scheduler.pending_tasks}/${scheduler.pending_capacity}`],
        ["Backpressure", String(scheduler.queue_backpressure_active)],
        ["Inflight keys", scheduler.inflight_keys],
        ["Workers", scheduler.worker_count],
      ];
      els.pipelineSnapshot.innerHTML = rows.map(([k, v]) => `<div><span class="text-slate-500">${k}:</span> <span class="mono">${v ?? "—"}</span></div>`).join("");
    }

    function solscanTx(sig) {
      return sig ? `https://solscan.io/tx/${sig}` : "#";
    }

    function solscanToken(token) {
      return token ? `https://solscan.io/token/${token}` : "#";
    }

    function solscanWallet(wallet) {
      return wallet ? `https://solscan.io/account/${wallet}` : "#";
    }

    function updatePager(key, count) {
      const p = state.pagination[key];
      p.count = count;
      p.hasMore = count >= p.limit;
      const start = count > 0 ? p.page * p.limit + 1 : 0;
      const end = count > 0 ? p.page * p.limit + count : 0;
      els.pagers[key].info.textContent = count > 0 ? `${start}-${end}` : "0";
      els.pagers[key].prev.disabled = p.page === 0;
      els.pagers[key].next.disabled = !p.hasMore;
    }

    function renderLots(lots) {
      if (!lots || !lots.length) {
        els.lotsTable.innerHTML = tableEmptyRow(8);
        updatePager("lots", 0);
        return;
      }
      els.lotsTable.innerHTML = lots.map((lot) => {
        const pnlClass = toColor(lot.unrealized_pnl_sol || 0);
        return `
          <tr>
            <td>${fmtTs(lot.opened_ts)}</td>
            <td><a class="text-blue-700 hover:underline mono" href="${solscanWallet(lot.wallet_id)}" target="_blank">${short(lot.wallet_id, 6)}</a></td>
            <td><a class="text-blue-700 hover:underline mono" href="${solscanToken(lot.token)}" target="_blank">${short(lot.token, 6)}</a></td>
            <td class="mono">${fmtNum(lot.qty, 6)}</td>
            <td class="mono">${fmtNum(lot.cost_sol, 5)}</td>
            <td class="mono">${lot.mark_price_sol_per_token === null ? "<span class='text-amber-700'>N/A</span>" : fmtNum(lot.mark_price_sol_per_token, 8)}</td>
            <td class="mono ${pnlClass}">${lot.unrealized_pnl_sol === null ? "N/A" : fmtNum(lot.unrealized_pnl_sol, 5)}</td>
            <td class="mono ${pnlClass}">${lot.unrealized_return_pct === null ? "N/A" : fmtPct(lot.unrealized_return_pct)}</td>
          </tr>
        `;
      }).join("");
      updatePager("lots", lots.length);
    }

    function renderTrades(trades) {
      if (!trades || !trades.length) {
        els.tradesTable.innerHTML = tableEmptyRow(8);
        updatePager("trades", 0);
        return;
      }
      els.tradesTable.innerHTML = trades.map((t) => {
        const pnlClass = toColor(t.pnl_sol);
        return `
          <tr>
            <td>${fmtTs(t.closed_ts)}</td>
            <td><a class="text-blue-700 hover:underline mono" href="${solscanWallet(t.wallet_id)}" target="_blank">${short(t.wallet_id, 6)}</a></td>
            <td><a class="text-blue-700 hover:underline mono" href="${solscanToken(t.token)}" target="_blank">${short(t.token, 6)}</a></td>
            <td class="mono">${fmtNum(t.qty, 6)}</td>
            <td class="mono">${fmtNum(t.entry_price_sol_per_token, 8)}</td>
            <td class="mono">${fmtNum(t.exit_price_sol_per_token, 8)}</td>
            <td class="mono ${pnlClass}">${fmtNum(t.pnl_sol, 5)} (${fmtPct(t.return_pct)})</td>
            <td class="mono">${t.hold_seconds}s</td>
          </tr>
        `;
      }).join("");
      updatePager("trades", trades.length);
    }

    function renderSignals(items) {
      if (!items || !items.length) {
        els.signalsTable.innerHTML = tableEmptyRow(8);
        updatePager("signals", 0);
        return;
      }
      els.signalsTable.innerHTML = items.map((s) => {
        const kindCls = s.kind === "dropped" ? "text-rose-700" : "text-emerald-700";
        const sig = s.signature ? `<a class="text-blue-700 hover:underline mono" href="${solscanTx(s.signature)}" target="_blank">${short(s.signature, 8)}</a>` : "—";
        return `
          <tr>
            <td>${fmtTs(s.ts)}</td>
            <td class="${kindCls} font-semibold">${s.kind}</td>
            <td>${s.wallet_id ? `<a class="text-blue-700 hover:underline mono" href="${solscanWallet(s.wallet_id)}" target="_blank">${short(s.wallet_id, 6)}</a>` : "—"}</td>
            <td>${s.token ? `<a class="text-blue-700 hover:underline mono" href="${solscanToken(s.token)}" target="_blank">${short(s.token, 6)}</a>` : "—"}</td>
            <td class="mono">${s.side || "—"}</td>
            <td class="mono">${s.reason || "—"}</td>
            <td class="mono">${s.status || "—"}</td>
            <td>${sig}</td>
          </tr>
        `;
      }).join("");
      updatePager("signals", items.length);
    }

    function renderDiscovery(payload) {
      const runtime = payload?.runtime || {};
      const metrics = payload?.top_metrics || [];
      const queryError = payload?.query_error || null;
      els.discoveryRuntime.innerHTML = `
        <div class="grid grid-cols-1 gap-1 md:grid-cols-3">
          <div><span class="text-slate-500">Last cycle:</span> <span class="mono">${fmtTs(runtime.last_cycle_ts)}</span></div>
          <div><span class="text-slate-500">Eligible wallets:</span> <span class="mono">${runtime.eligible_wallets ?? 0}</span></div>
          <div><span class="text-slate-500">Active follow:</span> <span class="mono">${runtime.active_follow_wallets ?? 0}</span></div>
        </div>
        ${queryError ? `<div class="mt-2 rounded-md border border-amber-300 bg-amber-50 px-2 py-1 text-amber-800">Metrics query degraded: ${queryError}</div>` : ""}
      `;
      if (!metrics || !metrics.length) {
        els.discoveryTable.innerHTML = tableEmptyRow(7);
        updatePager("discovery", 0);
        return;
      }
      els.discoveryTable.innerHTML = metrics.map((m) => `
        <tr>
          <td><a class="text-blue-700 hover:underline mono" href="${solscanWallet(m.wallet_id)}" target="_blank">${short(m.wallet_id, 6)}</a></td>
          <td class="mono">${fmtNum(m.score, 4)}</td>
          <td class="mono">${m.trades}</td>
          <td class="mono ${toColor(m.pnl)}">${fmtNum(m.pnl, 4)}</td>
          <td class="mono">${fmtPct(m.win_rate)}</td>
          <td class="mono">${fmtPct(m.tradable_ratio)}</td>
          <td class="mono">${fmtPct(m.rug_ratio)}</td>
        </tr>
      `).join("");
      updatePager("discovery", metrics.length);
    }

    function renderEventFeed() {
      const selection = window.getSelection ? window.getSelection() : null;
      if (selection && selection.type === "Range") {
        scheduleEventFeedRender();
        return;
      }
      els.eventFeed.innerHTML = state.events.map((e) => {
        const color =
          e.type === "signal_recorded" ? "text-emerald-300" :
          e.type === "signal_dropped" ? "text-rose-300" :
          e.type === "risk_state_changed" ? "text-amber-300" :
          e.type === "lagged" ? "text-rose-300" :
          "text-sky-300";
        const rawPayload = typeof e.payload === "object" ? JSON.stringify(e.payload) : String(e.payload ?? "");
        const payload = rawPayload.length > 1200 ? `${rawPayload.slice(0, 1200)} …[truncated]` : rawPayload;
        return `<div class="event-line border-b border-slate-700/60 pb-1 ${color}">
          [${fmtTs(e.ts)}] ${e.type}: <span class="text-slate-200">${payload}</span>
        </div>`;
      }).join("");
    }

    function scheduleEventFeedRender() {
      if (state.feedPaused) return;
      if (state.feedRenderTimer) return;
      state.feedRenderTimer = setTimeout(() => {
        state.feedRenderTimer = null;
        renderEventFeed();
      }, eventFeedRenderMs);
    }

    function pushEvent(event) {
      state.events.unshift(event);
      if (state.events.length > eventFeedLimit) state.events.length = eventFeedLimit;
      updateEventCount();
      scheduleEventFeedRender();
    }

    function currentOffset(key) {
      const p = state.pagination[key];
      return p.page * p.limit;
    }

    function pagePath(key) {
      const p = state.pagination[key];
      const offset = currentOffset(key);
      if (key === "lots") return `/api/lots?limit=${p.limit}&offset=${offset}`;
      if (key === "trades") return `/api/trades?limit=${p.limit}&offset=${offset}`;
      if (key === "signals") return `/api/signals?limit=${p.limit}&offset=${offset}`;
      return `/api/discovery?limit=${p.limit}&offset=${offset}`;
    }

    function buildPlanForView() {
      switch (state.activeView) {
        case "overview":
          return [
            { name: "dashboard", path: "/api/dashboard" },
            { name: "risk", path: "/api/risk" },
            { name: "ingestion", path: "/api/ingestion" },
          ];
        case "positions":
          return [
            { name: "lots", path: pagePath("lots") },
            { name: "trades", path: pagePath("trades") },
          ];
        case "signals":
          return [{ name: "signals", path: pagePath("signals") }];
        case "discovery":
          return [{ name: "discovery", path: pagePath("discovery") }];
        default:
          return [];
      }
    }

    function applyResponse(name, data) {
      if (name === "dashboard") {
        renderKpis(data);
        renderAlerts(data.health_alerts || []);
        return;
      }
      if (name === "risk") {
        renderRisk(data.runtime || {});
        return;
      }
      if (name === "ingestion") {
        renderPipeline(data.runtime || {}, data.scheduler || {});
        return;
      }
      if (name === "lots") {
        renderLots(data.lots || []);
        return;
      }
      if (name === "trades") {
        renderTrades(data.trades || []);
        return;
      }
      if (name === "signals") {
        renderSignals(data.items || []);
        return;
      }
      if (name === "discovery") {
        renderDiscovery(data);
      }
    }

    function queueRefresh(immediate = false) {
      if (!immediate && !state.autoRefreshEnabled) return;
      if (!state.token) return;
      if (state.refreshInFlight) {
        state.refreshQueued = true;
        return;
      }
      const elapsed = Date.now() - state.lastRefreshStartedAt;
      if (!immediate && elapsed < refreshCooldownMs) {
        const waitMs = refreshCooldownMs - elapsed;
        if (state.refreshDebounceTimer) return;
        state.refreshDebounceTimer = setTimeout(() => {
          state.refreshDebounceTimer = null;
          queueRefresh(true);
        }, waitMs);
        return;
      }
      refreshCurrentView();
    }

    async function refreshCurrentView() {
      if (!state.token) {
        setApiStatus("set token first", "bg-amber-400");
        return;
      }
      if (state.refreshInFlight) {
        state.refreshQueued = true;
        return;
      }
      const plan = buildPlanForView();
      if (!plan.length) {
        setApiStatus("ok", "bg-emerald-400");
        return;
      }

      state.refreshInFlight = true;
      state.lastRefreshStartedAt = Date.now();
      try {
        setApiStatus("loading", "bg-amber-400");
        const responses = await Promise.all(plan.map((item) => fetchNamed(item.name, item.path)));
        const failures = [];
        let successCount = 0;

        responses.forEach((entry) => {
          if (!entry.ok) {
            failures.push(`${entry.name}: ${String(entry.error?.message || entry.error || "unknown")}`);
            return;
          }
          successCount += 1;
          applyResponse(entry.name, entry.data);
        });

        if (failures.length === 0) {
          setApiStatus("ok", "bg-emerald-400");
          els.lastUpdate.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        } else if (successCount > 0) {
          setApiStatus(`degraded: ${failures[0].slice(0, 95)}`, "bg-amber-400");
          els.lastUpdate.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        } else {
          setApiStatus(failures[0].slice(0, 95), "bg-rose-400");
        }
      } finally {
        state.refreshInFlight = false;
        if (state.refreshQueued) {
          state.refreshQueued = false;
          queueRefresh(true);
        }
      }
    }

    function connectWs() {
      if (!state.token) return;
      if (state.ws) {
        state.ws.close();
        state.ws = null;
      }
      const scheme = location.protocol === "https:" ? "wss" : "ws";
      const url = `${scheme}://${location.host}/ws/live?token=${encodeURIComponent(state.token)}`;
      const ws = new WebSocket(url);
      state.ws = ws;

      ws.onopen = () => {
        setWsStatus("connected", "bg-emerald-400");
      };
      ws.onclose = () => {
        setWsStatus("disconnected", "bg-rose-400");
        if (state.wsRetryTimer) clearTimeout(state.wsRetryTimer);
        state.wsRetryTimer = setTimeout(connectWs, 3000);
      };
      ws.onerror = () => {
        setWsStatus("error", "bg-rose-400");
      };
      ws.onmessage = (msg) => {
        let payload;
        try {
          payload = JSON.parse(msg.data);
        } catch {
          return;
        }
        pushEvent(payload);
        if (state.autoRefreshEnabled) {
          const allowed = wsViewTriggers[state.activeView] || wsViewTriggers.events;
          if (allowed.has(payload.type)) {
            queueRefresh(false);
          }
        }
      };
    }

    function goPage(key, direction) {
      const page = state.pagination[key].page + direction;
      if (page < 0) return;
      if (direction > 0 && !state.pagination[key].hasMore) return;
      state.pagination[key].page = page;
      queueRefresh(true);
    }

    function bindPager(key) {
      els.pagers[key].prev.addEventListener("click", () => goPage(key, -1));
      els.pagers[key].next.addEventListener("click", () => goPage(key, 1));
      updatePager(key, 0);
    }

    function resetPagination() {
      Object.keys(state.pagination).forEach((key) => {
        state.pagination[key].page = 0;
        state.pagination[key].hasMore = false;
        state.pagination[key].count = 0;
        updatePager(key, 0);
      });
    }

    function saveToken() {
      state.token = normalizeToken(els.tokenInput.value);
      els.tokenInput.value = state.token;
      localStorage.setItem("copybot_token", state.token);
      resetPagination();
      state.events = [];
      updateEventCount();
      renderEventFeed();
      pushEvent({ type: "local", ts: new Date().toISOString(), payload: { message: "token updated" } });
      connectWs();
      queueRefresh(true);
    }

    function bootstrap() {
      if (!validViews.has(state.activeView)) {
        state.activeView = "overview";
      }
      els.tokenInput.value = state.token;
      bindPager("lots");
      bindPager("trades");
      bindPager("signals");
      bindPager("discovery");

      els.viewButtons.forEach((btn) => {
        btn.addEventListener("click", () => setActiveView(btn.dataset.view, true));
      });

      els.saveTokenBtn.addEventListener("click", saveToken);
      els.refreshBtn.addEventListener("click", () => queueRefresh(true));
      els.pauseFeedBtn.addEventListener("click", () => {
        state.feedPaused = !state.feedPaused;
        updatePauseFeedButton();
        updateEventCount();
        if (!state.feedPaused) {
          renderEventFeed();
        }
      });
      els.toggleAutoBtn.addEventListener("click", () => {
        state.autoRefreshEnabled = !state.autoRefreshEnabled;
        updateAutoRefreshButton();
        if (state.autoRefreshEnabled) {
          queueRefresh(false);
        }
      });
      els.tokenInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") saveToken();
      });

      updatePauseFeedButton();
      updateAutoRefreshButton();
      updateEventCount();
      setActiveView(state.activeView, false);

      if (!state.token) {
        setApiStatus("set token first", "bg-amber-400");
        setWsStatus("token missing", "bg-amber-400");
        return;
      }

      connectWs();
      queueRefresh(true);
      if (state.refreshTimer) clearInterval(state.refreshTimer);
      state.refreshTimer = setInterval(() => queueRefresh(false), 30000);
    }

    bootstrap();
  </script>
</body>
</html>
